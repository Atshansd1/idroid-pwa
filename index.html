<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>iDroid Android Web</title>
    <link rel="manifest" href="./manifest.webmanifest" />
    <meta name="theme-color" content="#111" />
    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="iDroid" />
    <!-- Optional: apple-touch-icon can be added later -->
    <style>
      html, body { height: 100%; margin: 0; background: #0b0b0b; }
      .frame { position: fixed; inset: 0; border: 0; width: 100%; height: 100%; }
      .banner { position: fixed; top: 8px; left: 8px; right: 8px; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
      .banner span { color: #fff; font: 500 14px/1.6 system-ui, -apple-system; opacity: 0.9; }
      .btn { background: #1e90ff; color: #fff; border: 0; border-radius: 8px; padding: 8px 12px; font: 600 13px/1.2 system-ui, -apple-system; cursor: pointer; }
      .status { display: inline-flex; align-items: center; gap: 8px; }
      .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
      .dot.ok { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
      .dot.down { background: #e74c3c; box-shadow: 0 0 8px #e74c3c; }
      .input { width: 320px; padding:6px 8px; border-radius:8px; border:1px solid #333; background:#111; color:#fff; }
    </style>
  </head>
  <body>
    <div class="banner">
      <span>Open in Safari → Share → Add to Home Screen</span>
      <div style="display:flex; gap:8px; align-items:center;">
        <div class="status"><span class="dot down" id="statusDot"></span><span id="statusText" style="color:#fff; opacity:.85;">Checking tunnel…</span></div>
        <input id="tunnelInput" class="input" type="url" placeholder="https://your-tunnel.trycloudflare.com/" />
        <button id="saveTunnel" class="btn">Use Tunnel</button>
        <button id="checkTunnel" class="btn" title="Re-check tunnel status">Check</button>
        <button id="openAdmin" class="btn" title="Open admin in new tab">Open Admin</button>
        <button id="installBtn" class="btn" hidden>Add to Home Screen</button>
      </div>
    </div>
    <iframe id="androidFrame" class="frame" src="" allow="clipboard-read; clipboard-write; fullscreen; autoplay; microphone; camera"></iframe>

    <script>
      const frame = document.getElementById('androidFrame');
      const input = document.getElementById('tunnelInput');
      const saveBtn = document.getElementById('saveTunnel');
      const checkBtn = document.getElementById('checkTunnel');
      const adminBtn = document.getElementById('openAdmin');
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');

      const defaultTunnel = 'https://listing-lanes-gravity-dispatched.trycloudflare.com/';
      const storedTunnel = window.localStorage.getItem('TUNNEL_URL');
      const TUNNEL_URL = storedTunnel || defaultTunnel;
      input.value = TUNNEL_URL;
      frame.src = TUNNEL_URL;

      saveBtn.addEventListener('click', () => {
        const url = input.value.trim();
        if (!url) return;
        try {
          const u = new URL(url);
          window.localStorage.setItem('TUNNEL_URL', u.href);
          frame.src = u.href;
          checkTunnel(u.href);
        } catch (e) {
          alert('Please enter a valid https:// URL');
        }
      });

      function setStatus(ok) {
        if (ok) {
          statusDot.classList.remove('down');
          statusDot.classList.add('ok');
          statusText.textContent = 'Tunnel OK';
        } else {
          statusDot.classList.remove('ok');
          statusDot.classList.add('down');
          statusText.textContent = 'Tunnel down';
        }
      }

      // Cross-origin reachability check via hidden iframe to root (avoids ORB/CORS noise)
      function checkTunnel(url) {
        const base = (url || input.value || defaultTunnel).replace(/\/$/, '/');
        const probe = document.createElement('iframe');
        probe.style.position = 'absolute';
        probe.style.width = '1px';
        probe.style.height = '1px';
        probe.style.left = '-9999px';
        probe.style.top = '-9999px';
        probe.referrerPolicy = 'no-referrer';
        let done = false;
        const cleanup = (ok) => {
          if (done) return;
          done = true;
          try { probe.remove(); } catch {}
          setStatus(ok);
        };
        const timeout = setTimeout(() => cleanup(false), 7000);
        probe.addEventListener('load', () => { clearTimeout(timeout); cleanup(true); });
        probe.addEventListener('error', () => { clearTimeout(timeout); cleanup(false); });
        probe.src = base + '?_=' + Date.now();
        document.body.appendChild(probe);
      }

      checkBtn.addEventListener('click', () => checkTunnel());
      // Auto-check every 30s
      checkTunnel(TUNNEL_URL);
      setInterval(checkTunnel, 30000);

      // Open admin with Basic Auth in a new tab
      adminBtn.addEventListener('click', () => {
        const base = (input.value || defaultTunnel).replace(/\/$/, '/');
        const user = prompt('Admin username:');
        if (user == null) return;
        const pass = prompt('Admin password:');
        if (pass == null) return;
        try {
          const u = new URL(base);
          // Inject credentials
          const credHost = `${u.protocol}//${encodeURIComponent(user)}:${encodeURIComponent(pass)}@${u.host}`;
          const adminUrl = `${credHost}/admin/`;
          window.open(adminUrl, '_blank', 'noopener');
        } catch (e) {
          alert('Invalid tunnel URL. Please set a valid https:// URL first.');
        }
      });

      // PWA install prompt
      let deferredPrompt;
      const installBtn = document.getElementById('installBtn');
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.hidden = false;
      });
      installBtn.addEventListener('click', async () => {
        installBtn.hidden = true;
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
      });

      // Register service worker for PWA
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      }
    </script>
  </body>
  </html>
